name: Generate M Code from API Collection

on:
  # Trigger when API collection file changes
  push:
    paths:
      - 'collections/atlassian-api.json'
      - 'collections/generator.py'
      - 'collections/templates/*.template'
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      categories:
        description: 'Endpoint categories to generate (space-separated, e.g., "Projects Issues")'
        required: false
        default: ''
        type: string
      generate_m_code:
        description: 'Generate M code files'
        required: false
        default: 'true'
        type: boolean
      generate_docs:
        description: 'Generate documentation articles'
        required: false
        default: 'true'
        type: boolean
      force_regenerate:
        description: 'Force regeneration of all files'
        required: false
        default: 'false'
        type: boolean

jobs:
  generate-m-code:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Add any additional dependencies if needed
        # pip install -r requirements.txt

    - name: Generate M Code files
      run: |
        cd collections
        echo "ðŸš€ Starting M code generation..."
        
        # Build generator command with options
        GENERATOR_CMD="python3 generator.py"
        
        # Add category filter if specified
        if [ -n "${{ github.event.inputs.categories }}" ]; then
          GENERATOR_CMD="$GENERATOR_CMD --categories ${{ github.event.inputs.categories }}"
          echo "ðŸ“‚ Categories: ${{ github.event.inputs.categories }}"
        else
          echo "ðŸ“‚ Categories: All categories"
        fi
        
        # Add generation type flags
        if [ "${{ github.event.inputs.generate_m_code }}" = "false" ]; then
          GENERATOR_CMD="$GENERATOR_CMD --docs-only"
          echo "ðŸ“ Mode: Documentation only"
        elif [ "${{ github.event.inputs.generate_docs }}" = "false" ]; then
          GENERATOR_CMD="$GENERATOR_CMD --m-code-only"
          echo "âš™ï¸ Mode: M code only"
        else
          echo "ðŸ“‹ Mode: M code and documentation"
        fi
        
        echo "ðŸš€ Running: $GENERATOR_CMD"
        $GENERATOR_CMD
        
        echo "âœ… M code generation completed"

    - name: Check for changes
      id: git-check
      run: |
        # Check both assets (M code) and docs (documentation) directories
        if [ -n "$(git status --porcelain assets/ docs/)" ]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "ðŸ“ Changes detected in generated files"
          echo "M code files:"
          git status --short assets/ || echo "No M code changes"
          echo "Documentation files:"
          git status --short docs/ || echo "No documentation changes"
        else
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ No changes in generated files"
        fi

    - name: Commit and push changes
      if: steps.git-check.outputs.changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action - M Code Generator"
        
        # Add all new and modified M code and documentation files
        git add assets/*.m docs/jira-*.md
        
        # Count files
        NEW_FILES=$(git diff --cached --name-only --diff-filter=A | wc -l)
        MODIFIED_FILES=$(git diff --cached --name-only --diff-filter=M | wc -l)
        
        # Create commit message
        CATEGORIES_MSG=""
        if [ -n "${{ github.event.inputs.categories }}" ]; then
          CATEGORIES_MSG="- Categories: ${{ github.event.inputs.categories }}"
        else
          CATEGORIES_MSG="- Categories: All categories"
        fi
        
        # Count M code and documentation files separately
        M_CODE_FILES=$(git diff --cached --name-only | grep -c '\.m$' || echo "0")
        DOC_FILES=$(git diff --cached --name-only | grep -c '\.md$' || echo "0")
        
        COMMIT_MSG="ðŸ¤– Auto-generate M code and documentation

        ðŸ“Š Summary:
        - M code files: $M_CODE_FILES
        - Documentation files: $DOC_FILES
        - Total new files: $NEW_FILES
        - Total modified files: $MODIFIED_FILES
        - Generated from: collections/atlassian-api.json
        $CATEGORIES_MSG
        - Generator version: $(date +'%Y-%m-%d %H:%M:%S')
        
        ðŸ” Files updated:
        $(git diff --cached --name-only | sed 's/^/- /')"
        
        git commit -m "$COMMIT_MSG"
        git push

    - name: Create summary
      run: |
        echo "## ðŸ¤– M Code & Documentation Generation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.git-check.outputs.changes }}" == "true" ]; then
          echo "âœ… **Status**: Changes detected and committed" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **M Code Location**: \`assets/\` directory" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“š **Documentation Location**: \`docs/\` directory" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”„ **Trigger**: API collection or generator updates" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ **Status**: No changes detected" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ¯ **Reason**: Generated files match existing files" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Generation Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Source**: \`collections/atlassian-api.json\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Generator**: \`collections/generator.py\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Templates**: \`collections/templates/\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Rules**: Following \`.cursor/rules/api-generation-rules.mdc\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Scope**: GET endpoints only (264 total)" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ¯ Generated Content" >> $GITHUB_STEP_SUMMARY
        echo "- **M Code Files**: Ready for use in Power Query with authentication and deep JSON expansion" >> $GITHUB_STEP_SUMMARY
        echo "- **Business Documentation**: Project manager-focused articles explaining business value" >> $GITHUB_STEP_SUMMARY
        echo "- **Jekyll Integration**: Files marked with \`draft: true\` and proper front matter" >> $GITHUB_STEP_SUMMARY
        echo "- **Cross-Referenced**: Documentation links to corresponding M code files" >> $GITHUB_STEP_SUMMARY

    - name: Notify on failure
      if: failure()
      run: |
        echo "## âŒ M Code Generation Failed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The automated M code generation process encountered an error." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ” Troubleshooting" >> $GITHUB_STEP_SUMMARY
        echo "1. Check the API collection file format (\`collections/atlassian-api.json\`)" >> $GITHUB_STEP_SUMMARY
        echo "2. Verify generator script syntax (\`collections/generator.py\`)" >> $GITHUB_STEP_SUMMARY
        echo "3. Ensure all templates are present (\`collections/templates/\`)" >> $GITHUB_STEP_SUMMARY
        echo "4. Review the action logs for specific error details" >> $GITHUB_STEP_SUMMARY
